<%- include('../layouts/user/userheader.ejs') -%>

  <body>
    <style>
      .table {
        border-collapse: collapse;
        width: 100%;
        max-width: 800px;
        margin: auto;
      }

      .table thead th {
        background-color: #f5f5f5;
        border-bottom: 1px solid #ddd;
        padding: 10px;
        text-align: left;
      }

      .table tbody td {
        border-bottom: 1px solid #ddd;
        padding: 10px;
        text-align: left;
      }

      .table tfoot td {
        background-color: #f5f5f5;
        border-top: 1px solid #ddd;
        font-weight: bold;
        padding: 10px;
        text-align: left;
      }
			.table {
  font-size: 14px;
  border-collapse: collapse;
  border-spacing: 0;
}

th,
td {
  padding: 6px;
}

tfoot td {
  font-weight: bold;
}

      
    </style>
    <style>
        .delivery-heading {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 20px;
}

.delivery-addresses {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  margin-bottom: 20px;
}

.address-name {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 10px;
}

.address-info {
  margin-bottom: 5px;
}

.add-new-address {
  margin-top: 10px;
}

.coupon-area {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.coupon-input {
  width: 75%;
  padding: 10px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.apply-coupon {
  color: #fff;
  background-color: #28a745;
  border-color: #28a745;
  padding: 10px 20px;
  border-radius: 4px;
}

.new-table {
  font-size: 14px;
  border-collapse: collapse;
  border-spacing: 0;
}

.new-table th,
.new-table td {
  padding: 6px;
}

.new-table tfoot td {
  font-weight: bold;
}


    </style>
 

 <body class="goto-here">
  <% if(typeof userData !== "undefined"){ %>
    <%-include('login_nav') %>
  <%}else{%>
    <%- include('not_logged_nav') %>
  <%}%>
<div class="hero-wrap hero-bread" style="background-image: url('images/bg_1.jpg');">
  <div class="container">
    <div class="row no-gutters slider-text align-items-center justify-content-center">
      <div class="col-md-9 ftco-animate text-center">
        <p class="breadcrumbs"><span class="mr-2"><a href="index.html">Home</a></span> <span>Products</span></p>
        <h1 class="mb-0 bread">Products</h1>
      </div>
    </div>
  </div>
</div>








    <div class="container main">
      <div class="profile">
        <div class="container">
          <section class="h-100 h-custom" style="background-color: #ffffff">
            <div class="container py-5 h-100">
              <div
                class="row d-flex justify-content-center align-items-center h-100"
              >
                <div class="col-12">
                  <br /><br /><br />
                  <div
                    class="card card-registration card-registration-2"
                    style="border-radius: 15px"
                  >
                    <div class="card-body p-0">
                      <div class="row g-0">
                        <div class="col-lg-12">
                          <div class="p-5">
                            <div class="container">
                              <div class="row billing-fields">
                                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 sm-margin-30px-bottom">
                                    <div class="create-ac-content bg-light-gray padding-20px-all">
                                      <h2 class="delivery-heading">Deliver to:</h2>
                                      <!-- <div class="delivery-addresses">
                                        <% if (address) { %>
                                        <select class="form-select form-select-lg mb-3" id="addressform">
                                          <% address.forEach(function(item) { %>
                                          <option <%= item._id %>>
                                            <div class="col-md-6">
                                              <div class="bg-white card addresses-item mb-4 border border-primary shadow">
                                                <div class="gold-members p-4">
                                                  <div class="media">
                                                    <div class="mr-3">
                                                      <i class="icofont-ui-home icofont-3x"></i>
                                                    </div>
                                                    <div class="media-body">
                                                      <h6 class="address-name"><%= item.deliver_to %></h6>
                                                      <p class="address-info"><%= item.name %>&nbsp;&nbsp;<b><%= item.number %></b></p>
                                                      <p class="address-info"><%= item.house %></p>
                                                      <p class="address-info"><%= item.city %>, <%= item.state %>, <%= item.country %></p>
                                                      <p class="address-info"><%= item.address %> - <%= item.pincode %></p>
                                                    </div>
                                                  </div>
                                                </div>
                                              </div>
                                            </div>
                                          </option>
                                          <% }); %>
                                        </select>
                                        <% } %>
                                        <div class="add-new-address">
                                          <a href="/addaddressCheckout?id=<%=userData%>" class="btn btn-outline-dark"><strong>Add new Address</strong></a>
                                        </div>
                                      </div> -->
                                      
                                      <div class="create-ac-content bg-light-gray padding-20px-all">
                                        <br><br>

                                        <% if (address) { %>
                                            <% for (i = 0; i < address.length; i++) { %>
                                              <div class="col">
                                                <div class="card shadow-sm">
                                                  <div class="card-body" >
                                                    <label class="radio-container">
                                                      <input type="radio" class="radios" id="address_<%= i %>" name="address" value="<%= address[i].name %>,  <%=address[i].house %>, <%= address[i].city %>, <%= address[i].state %>, <%= address[i].pincode %>, <%= address[i].mobile %> " required>&nbsp;
                                                      <span class="checkmark"></span>
                                                    </label>
                                                     <%= address[i].houseName %><br>
                                                      <%= address[i].houseNumber%><br>
                                                      <%= address[i].street %><br>
                                                      <%= address[i].landmark %><br>
                                                      <%= address[i].city %><br>
                                                      <%= address[i].state %><br>
                                                      <%= address[i].pincode %><br>
                                                      
                                                        <a href="/editAddress?id=<%=address._id%>"><span class="material-symbols-outlined">edit_note</span></a>
                                                        <a  href="/deleteAddress?id=<%=address._id%>" onclick="return confirm('Are You Sure ?')"><span class="material-symbols-outlined"> delete </span></a>
                                                      
                                                  </div>
                                                </div>
                                              </div>
                                            <% } %>
                                          <% } else { %>
                                            <div>
                                              <p>No Address Found. Please add Address.</p>
                                            </div>
                                          <% } %>
                                            <br>
                                            <div class="d-flex justify-content-left mb-2">
                                                <a href="/addaddressCheckout?id=<%=userData%>"
                                                    class="btn btn-outline-dark"><strong>Add new
                                                        Address</strong></a>
                                            </div>
                                        </div>
                                      
                                      
                                      
                                      
                                      
                                      
                                      
                                      
                                      
                                      
                                      <div class="coupon-area">
                                        <div class="check_title"></div>
                                        <input type="text" name="coupon" id="couponcode" class="coupon-input" placeholder="Enter coupon code" />
                                        <button class="btn bg-success apply-coupon" onclick="checkCoupon()" href="">Apply Coupon</button>

                                        <span id="errorMessage" class="coupon-error"></span>

                                      </div>
                                    </div>
                                  </div>
                                  
                                <div
                                  class="col-xl-6 col-lg-6 col-md-6 col-sm-12"
                                >
                                  <div class="your-order-payment">
                                    <div class="your-order">
                                      <h2 class="order-title mb-4">
                                        Your Order
                                      </h2>

                                      <!-- <div class="table-responsive-sm order-table table-bordered"> -->
																			<table class="new-table table-bordered " >
																				<thead>
																					<tr>
																						<th scope="col">Product Name</th>
																						<th scope="col">Quantity</th>
																						<th scope="col">Price</th>
																					</tr>
																				</thead>
																				<tbody>
																					<% productDetails.forEach(function(product) { %>
																					<tr>
																						<td scope="row"><%= product.productName %></td>
																						
																						<td><%= product.quantity %></td>
																						<td><%= product.price %></td>
																						<input type="hidden" name="productid" value="<%= product._id %>" />
																						<input type="hidden" name="productname" value="<%= product.productName %>" />
																						<input type="hidden" name="price" value="<%= product.price %>" />
																						<input type="hidden" name="quantity" value="<%= product.quantity %>" />
																					</tr>
																					<% }); %>
																				</tbody>
																				<tfoot>
																					<tr>
																						<td>Total</td>
																						<td></td>
																						<td><%= subtotal %></td>
																						<input type="hidden" id="subtotal" value="<%= subtotal %>" />
																					</tr>
																					<tr>
																						<td>Offer</td>
																						<td></td>
																						<td id="offer" ><%= offer %> %</td>
																						<input type="hidden" />
																					</tr>
																					<tr>
																						<td>Total Amount</td>
																						<td></td>
																						<td id="gtotal" ><%= total %></td>
																						<input type="hidden" id="ftotal" value="<%= total %>" />
																					</tr>
																				</tfoot>
																			</table>
                                      
                                    </div>
                                  
                                    <hr />
                                    <div class="your-payment">
                                      <h2 class="payment-title mb-3">
                                        Payment Method
                                      </h2>
                                      <br />
                                      <div class="payment-method">
                                        <div class="form-check">
                                          <input
                                            onclick="enableButton()"
                                            class="form-check-input"
                                            type="radio"
                                            name="payment"
                                            id="COD"
                                            value="1"
                                          />
                                          <label
                                            class="form-check-label"
                                            for="payment1"
                                          >
                                            Cash On Delivery
                                          </label>
                                          <div>
                                            <input
                                              onclick="enableButton()"
                                              class="form-check-input"
                                              type="radio"
                                              name="payment"
                                              id="rzp-button1"
                                              value="2"
                                            />
                                            <label
                                              class="form-check-label"
                                              for="payment2"
                                            >
                                              RazorPay
                                            </label>
                                          </div>
                                        </div>
                                        <hr />
                                        <div class="order-button-payment">
                                          <button
                                            class="btn btn-success"
                                            onclick="CheckplaceOrder()"
                                            value="Place order"
                                            id="placeOrderButton"
                                            disabled
                                          >
                                            Place order
                                          </button>
                                        </div>
                                        <input
                                          type="hidden"
                                          name="radioValue"
                                        />
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- Checkout Section End -->
		<%- include('../layouts/user/userfooter.ejs') -%>


    <!-- Js Plugins -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/jquery.slicknav.js"></script>
    <script src="js/mixitup.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/main.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.16/dist/sweetalert2.all.min.js"></script>
  

    <script>
      let Rtotal;
      let addressId;
      let payment;
      let subtotal;

      subtotal = Number(document.getElementById("subtotal").value);
     Rtotal = Number(document.getElementById('ftotal').value);
      
     
     async function enableButton() {
      var radioButtons = document.getElementsByName("address");
      for (var i = 0; i < radioButtons.length; i++) {
        radioButtons[i].addEventListener('click', function() {
          var id = this.id;
           addressId= document.getElementById(id).value;
         
        });
      }
        if(addressId)
         document.getElementById('placeOrderButton').disabled = false
         else {Swal.fire({

                    text: "Add address first !",
                    icon: 'error',
                    showConfirmButton: false, 
                    iconHtml: '<i class="fas fa-map-marker-alt"></i>',
                    timer: 1000
                })  
            }
        }

    

      // ------------------------------------------RAZORPAY------------------------------------------------------------------

      async function CheckplaceOrder() {
        payment = Object.values(document.getElementsByName("payment"))
          .filter((item) => (item.checked ? item : ""))
          .map((item) => item.value);
        if (payment[0] === "1" && addressId) {
          placeOrder();
        } else if (payment[0] == "2" && addressId) {
          var orderId;
          $(document).ready(function () {
            console.log(Rtotal);
            var settings = {
              url: "/create/orderId",
              method: "POST",
              timeout: 0,
              headers: {
                "Content-Type": "application/json",
              },
              data: JSON.stringify({
                amount: Rtotal * 100, //CHANGE THE AMOUNT AS NEEDED
              }),
            };

            //creates new orderId everytime
            $.ajax(settings).done(function (response) {
              orderId = response.orderId;
              console.log(orderId);
            });
          });

          document.getElementById("placeOrderButton").onclick = function (e) {
            var options = {
              key: "rzp_test_3Du1BVXtxPAKWc", // Enter the Key ID generated from the Dashboard
              amount: Rtotal * 100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
              currency: "INR",
              name: "HANDPICKED",
              description: "Fresh N Natural",
              image: "https://t3.ftcdn.net/jpg/03/11/87/52/360_F_311875255_d57wDCwlZxdtOEwsnmXLHkV1r29i1R2U.jpg",
              order_id: orderId, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
              handler: function (response) {
                // alert(response.razorpay_payment_id);
                // alert(response.razorpay_order_id);
                // alert(response.razorpay_signature);
                var settings = {
                  url: "/api/payment/verify",
                  method: "POST",
                  timeout: 0,
                  headers: {
                    "Content-Type": "application/json",
                  },
                  data: JSON.stringify({ response }),
                };
                console.log(response);
                console.log("");
                $.ajax(settings).done(function (response) {
                  placeOrder();
                  alert(JSON.stringify(response));
                });
              },

              theme: {
                color: "#82ae46",
              },
            };
            var rzp1 = new Razorpay(options);
            rzp1.on("payment.failed", function (response) {
              alert(response.error.code);
              // alert(response.error.description);
              // alert(response.error.source);
              // alert(response.error.step);
              // alert(response.error.reason);
              // alert(response.error.metadata.order_id);
              // alert(response.error.metadata.payment_id);
            });
            rzp1.open();
            e.preventDefault();
          };
        }
      }
      //   ------------------------------------------RAZORPAY-------------------------------------------------------------------

      async function placeOrder() {
        const productid = Object.values(
          document.getElementsByName("productid")
        ).map((item) => item.value);
        const productname = Object.values(
          document.getElementsByName("productname")
        ).map((item) => item.value);
        const price = Object.values(document.getElementsByName("price")).map(
          (item) => item.value
        );
        const quantity = Object.values(
          document.getElementsByName("quantity")
        ).map((item) => item.value);
        
      
        const couponcode = document.getElementById("couponcode").value;

        let data = {
          productid: productid,
          productname: productname,
          price: price,
          quantity: quantity,
          addressId: addressId,
          payment: payment,
          subtotal: subtotal,
          coupon: couponcode,
        };

        try {
          let orderplacement = await fetch("/place-order", {
            method: "post",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });
          let result = await orderplacement.json();
        

          if (result.res === "success") {
            Swal.fire({
              title: "Success",
              text: "Item ordered successfully !",
              icon: "success",
              confirmButtonColor: "#3085d6",
              cancelButtonColor: "#d33",
              confirmButtonText: "OK",
              timer: 3000,
            }).then((res) => {
              window.location.href = "/success";
            });
          } else {
            Swal.fire({
              title: "Something went wrong",
              text: "something went wrong !",

              icon: "failure",
              confirmButtonColor: "#3085d6",
              cancelButtonColor: "#d33",
              confirmButtonText: "OK",
              timer: 3000,
            }).then((res) => {
              window.location.href = "/home";
            });
          }
        } catch (error) {
          console.log(error);
        }
      }
// .....................COUPON VALIDATION..................


      async function checkCoupon() {
        const coupon = document.getElementById("couponcode").value;
        const total = document.getElementById("subtotal").value;
        console.log(coupon);
        let valCoupon = await fetch("/validateCoupon", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code: coupon, total: total }),
        });
        let response = await valCoupon.json();
        console.log(response.gtotal);
        if (response == "fail") {
          document.getElementById("errorMessage").innerHTML = "Coupon Invalid";
        } else {
          Rtotal = response.gtotal;
          let offer = (document.getElementById("offer").innerHTML = Number(
            response.offerPrice
          ));

          console.log(Number(response.offerPrice));

          let subtotal = document.getElementById("subtotal").value;

          let gtotal = document.getElementById("gtotal").innerHTML;

          const amt = (Number(subtotal) * Number(offer)) / 100;

          gtotal = gtotal - amt;

          document.getElementById("gtotal").innerHTML = gtotal;
        }
      }

      function removeCoupon(){
         // Remove the coupon code from the applied coupon field
  document.getElementById("offer").value = "";
  
  // Update the display to show the coupon has been removed
  alert("Coupon removed successfully!");
      }
    </script>
  </body>
</html>